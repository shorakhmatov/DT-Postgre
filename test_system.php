<?php
/**
 * Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°Ð¼Ð¸
 * ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”, Redis Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
 */

require_once __DIR__ . '/config/config.php';

echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°Ð¼Ð¸\n";
echo "==========================================\n\n";

$errors = [];
$warnings = [];

// Ð¢ÐµÑÑ‚ 1: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "1. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MySQL...\n";
try {
    $pdo = getDbConnection();
    echo "   âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MySQL ÑƒÑÐ¿ÐµÑˆÐ½Ð¾\n";
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†
    $tables = ['categories', 'products', 'orders', 'statistics'];
    foreach ($tables as $table) {
        $stmt = $pdo->query("SHOW TABLES LIKE '$table'");
        if ($stmt->rowCount() > 0) {
            echo "   âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° '$table' ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚\n";
        } else {
            $errors[] = "Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° '$table' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°";
            echo "   âŒ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° '$table' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°\n";
        }
    }
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
    $stmt = $pdo->query("SELECT COUNT(*) as count FROM products");
    $productCount = $stmt->fetch()['count'];
    echo "   ðŸ“Š ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð² Ð‘Ð”: $productCount\n";
    
    $stmt = $pdo->query("SELECT COUNT(*) as count FROM orders");
    $orderCount = $stmt->fetch()['count'];
    echo "   ðŸ“Š Ð—Ð°ÐºÐ°Ð·Ð¾Ð² Ð² Ð‘Ð”: $orderCount\n";
    
} catch (Exception $e) {
    $errors[] = "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MySQL: " . $e->getMessage();
    echo "   âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MySQL: " . $e->getMessage() . "\n";
}

echo "\n";

// Ð¢ÐµÑÑ‚ 2: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Redis
echo "2. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Redis...\n";
try {
    $redis = getRedisConnection();
    $redis->ping();
    echo "   âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Redis ÑƒÑÐ¿ÐµÑˆÐ½Ð¾\n";
    
    // Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ Redis
    $testKey = 'test_key_' . time();
    $redis->set($testKey, 'test_value', 10);
    $value = $redis->get($testKey);
    if ($value === 'test_value') {
        echo "   âœ… ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ Redis Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚\n";
        $redis->del($testKey);
    } else {
        $warnings[] = "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑÐ¼Ð¸ Redis";
        echo "   âš ï¸ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑÐ¼Ð¸ Redis\n";
    }
    
} catch (Exception $e) {
    $warnings[] = "Redis Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: " . $e->getMessage();
    echo "   âš ï¸ Redis Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: " . $e->getMessage() . "\n";
    echo "   â„¹ï¸ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð±ÐµÐ· ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ\n";
}

echo "\n";

// Ð¢ÐµÑÑ‚ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PHP ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²
echo "3. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ PHP ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²...\n";

$scripts = [
    'alpha.php' => 'scripts/alpha.php',
    'beta.php' => 'scripts/beta.php',
    'gamma.php' => 'scripts/gamma.php'
];

foreach ($scripts as $name => $path) {
    if (file_exists($path)) {
        echo "   âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ $name Ð½Ð°Ð¹Ð´ÐµÐ½\n";
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ
        $output = [];
        $return_var = 0;
        exec("php -l $path 2>&1", $output, $return_var);
        
        if ($return_var === 0) {
            echo "   âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ $name ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½\n";
        } else {
            $errors[] = "Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² $name";
            echo "   âŒ Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² $name\n";
        }
    } else {
        $errors[] = "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ $name Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½";
        echo "   âŒ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ $name Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½\n";
    }
}

echo "\n";

// Ð¢ÐµÑÑ‚ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÐ±-ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
echo "4. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÐµÐ±-ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°...\n";
if (file_exists('client/index.html')) {
    echo "   âœ… Ð’ÐµÐ±-ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ð°Ð¹Ð´ÐµÐ½\n";
    
    $content = file_get_contents('client/index.html');
    if (strpos($content, 'scripts/beta.php') !== false) {
        echo "   âœ… Ð¡ÑÑ‹Ð»ÐºÐ¸ Ð½Ð° API ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹\n";
    } else {
        $warnings[] = "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ ÑÐ¾ ÑÑÑ‹Ð»ÐºÐ°Ð¼Ð¸ Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ";
        echo "   âš ï¸ Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ ÑÐ¾ ÑÑÑ‹Ð»ÐºÐ°Ð¼Ð¸ Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ\n";
    }
} else {
    $errors[] = "Ð’ÐµÐ±-ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½";
    echo "   âŒ Ð’ÐµÐ±-ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½\n";
}

echo "\n";

// Ð¢ÐµÑÑ‚ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð¸ Ð¿Ñ€Ð°Ð²
echo "5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...\n";

$directories = ['config', 'database', 'scripts', 'client'];
foreach ($directories as $dir) {
    if (is_dir($dir)) {
        echo "   âœ… Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ '$dir' ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚\n";
    } else {
        $errors[] = "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ '$dir' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°";
        echo "   âŒ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ '$dir' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°\n";
    }
}

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if (!is_dir('logs')) {
    if (mkdir('logs', 0755, true)) {
        echo "   âœ… Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ 'logs' ÑÐ¾Ð·Ð´Ð°Ð½Ð°\n";
    } else {
        $warnings[] = "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ 'logs'";
        echo "   âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ 'logs'\n";
    }
} else {
    echo "   âœ… Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ 'logs' ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚\n";
}

echo "\n";

// Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
echo "ðŸ“‹ Ð˜Ð¢ÐžÐ“ÐžÐ’Ð«Ð™ ÐžÐ¢Ð§Ð•Ð¢\n";
echo "================\n";

if (empty($errors)) {
    echo "ðŸŽ‰ Ð’ÑÐµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!\n";
} else {
    echo "âŒ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:\n";
    foreach ($errors as $error) {
        echo "   â€¢ $error\n";
    }
}

if (!empty($warnings)) {
    echo "\nâš ï¸ ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ:\n";
    foreach ($warnings as $warning) {
        echo "   â€¢ $warning\n";
    }
}

echo "\nðŸš€ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°:\n";
echo "1. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ SQL ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¸Ð· Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ database/\n";
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€: php -S localhost:8000 -t .\n";
echo "3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ http://localhost:8000/client/ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ\n";
echo "4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Redis Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸\n";

echo "\nâœ¨ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ!\n";
?>
